<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ” El Impostor</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <audio id="bgMusic" loop>
    <source src="musica.mp3" type="audio/mpeg">
    Tu navegador no soporta audio.
  </audio>

  <div id="volumeControl">
    <span>ğŸ”Š</span>
    <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.3">
  </div>

  <section id="agradecimientos" class="screen active">
    <h1>AGRADECIMIENTOS</h1>

    <p><strong>ğŸ‘©â€ğŸ’» Desarrollador:</strong><br>Gabriela Lopez</p>
    <p><strong>ğŸ¹ MÃºsica:</strong><br>Victor Zerpa</p>
    <p><strong>ğŸ¨ Arte y AnimaciÃ³n:</strong><br>
      Arianna Escalona<br>
      Elian Garcia
    </p>

    <p class="thanks">
      Agradecimientos especiales ğŸ¥º al Profesor
      <strong>Gabriel Baute</strong>
      por guiarnos en el desarrollo de este proyecto ğŸ¤ ğŸ¤
    </p>

    <button id="btnContinuar">Continuar</button>
  </section>

  <section id="inicio" class="screen">
    <h1>ğŸ” EL IMPOSTOR ğŸ•µï¸</h1>
    <button id="btnJugar">Jugar</button>
  </section>

  <section id="jugadores" class="screen">
    <h2>Jugadores (2 a 10)</h2>

    <input
      type="text"
      id="nombreJugador"
      placeholder="Nombre del jugador"
      autocomplete="off"
    >

    <button id="btnAgregarJugador">Agregar</button>

    <ul id="listaJugadores"></ul>

    <button id="btnContinuarCategorias">Continuar</button>
  </section>

  <section id="categorias" class="screen">
    <h2>Selecciona una categorÃ­a</h2>

    <select id="selectCategoria">
      <option value="">-- Selecciona --</option>
      <option value="comida">Comida</option>
      <option value="lugares">Lugares</option>
      <option value="animales">Animales</option>
    </select>

    <br><br>

    <button id="btnAsignarPalabras">Asignar Palabras</button>
  </section>

  <section id="palabra" class="screen">
    <h2 id="turnoJugador"></h2>

    <div id="palabraSecreta" class="blur">
      TOCA PARA VER
    </div>

    <p class="hint">
      No dejes que otros vean la pantalla
    </p>

    <button id="btnSiguienteJugador">Siguiente</button>
  </section>

  <section id="temporizador" class="screen">
    <h2>Tiempo para jugar</h2>
    <div id="tiempo">2:00</div>
    <p>Digan una palabra relacionada</p>
  </section>

  <section id="votacion" class="screen">
    <h2>VotaciÃ³n</h2>
    <p>Â¿QuiÃ©n es el impostor?</p>

    <div id="opcionesVoto"></div>
  </section>

  <section id="resultado" class="screen">
    <div id="resultadoTexto"></div>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  
  <script src="palabras.js"></script>
  <script src="script.js"></script>


    <!-- ========== CONFIGURACIÃ“N FIREBASE ========== -->
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

<!-- ========== MÃ“DULO DE SALA ONLINE ========== -->
<section id="onlineConnect" class="screen">
  <h2>ğŸ® Sala Online</h2>

  <!-- Controles de sala -->
  <div id="onlineRoomControls">
    <button id="btnCrearSalaOnline">â• Crear sala</button>
    <button id="btnUnirseSalaOnline">ğŸ”— Unirse a sala</button>
  </div>

  <!-- InformaciÃ³n de sala activa -->
  <div id="onlineRoomInfo" style="display: none;">
    <p>CÃ³digo de sala: <strong id="onlineRoomCode">---</strong></p>
    <p>Jugadores conectados:</p>
    <ul id="listaJugadoresOnline"></ul>
    <button id="btnAgregarAJugadores">â• Agregar a la partida</button>
    <button id="btnSalirSalaOnline">ğŸšª Salir</button>
  </div>

  <!-- Panel para unirse a sala -->
  <div id="onlineJoinPanel" style="display: none;">
    <input type="text" id="onlineRoomCodeInput" placeholder="CÃ³digo de 6 dÃ­gitos" maxlength="6">
    <button id="btnConfirmarUnirseOnline">Unirse</button>
    <button id="btnCancelarUnirseOnline">Cancelar</button>
  </div>

  <button id="btnVolverAJugadores">â¬… Volver</button>
</section>

<script>
  // ========== FIREBASE - CONFIGURACIÃ“N (CREDENCIALES) ==========
  const firebaseConfig = {
    apiKey: "AIzaSy...",
    authDomain: "tu-proyecto.firebaseapp.com",
    projectId: "tu-proyecto",
    storageBucket: "tu-proyecto.appspot.com",
    messagingSenderId: "123456789",
    appId: "1:123456789:web:abc123"
  };

  // Inicializar Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ========== ESTADO DE LA SALA ONLINE ==========
  let onlineRoomId = null;         // CÃ³digo de la sala
  let onlinePlayerName = "";      // Nombre del jugador actual (para salas ajenas)
  let unsubscribeRoom = null;    // Listener de Firestore
  let isHost = false;           // Â¿El jugador actual es el anfitriÃ³n?

  // ========== REFERENCIAS DOM ==========
  const btnCrearSala = document.getElementById("btnCrearSalaOnline");
  const btnUnirseSala = document.getElementById("btnUnirseSalaOnline");
  const btnConfirmarUnirse = document.getElementById("btnConfirmarUnirseOnline");
  const btnCancelarUnirse = document.getElementById("btnCancelarUnirseOnline");
  const btnSalirSala = document.getElementById("btnSalirSalaOnline");
  const btnAgregarAJugadores = document.getElementById("btnAgregarAJugadores");
  const onlineRoomInfo = document.getElementById("onlineRoomInfo");
  const onlineRoomControls = document.getElementById("onlineRoomControls");
  const onlineJoinPanel = document.getElementById("onlineJoinPanel");
  const onlineRoomCodeSpan = document.getElementById("onlineRoomCode");
  const listaJugadoresOnline = document.getElementById("listaJugadoresOnline");
  const btnVolver = document.getElementById("btnVolverAJugadores");

  // ========== FUNCIONES ==========
  function mostrarPantallaOnline() {
    mostrarPantalla("onlineConnect");
  }

  // Genera cÃ³digo aleatorio de 6 dÃ­gitos
  function generarCodigoSala() {
    return Math.floor(100000 + Math.random() * 900000).toString();
  }

  // Crear una nueva sala (anfitriÃ³n)
  async function crearSala() {
    try {
      onlineRoomId = generarCodigoSala();
      onlinePlayerName = "AnfitriÃ³n";
      isHost = true;

      await db.collection("salas").doc(onlineRoomId).set({
        jugadores: [onlinePlayerName],
        creada: firebase.firestore.FieldValue.serverTimestamp(),
        host: onlinePlayerName
      });

      iniciarEscuchaSala(onlineRoomId);
      mostrarControlesSala();
    } catch (error) {
      alert("Error al crear sala: " + error.message);
    }
  }

  // Unirse a una sala existente
  async function unirseASala(codigo, nombreJugador) {
    if (!codigo || !nombreJugador) return alert("CÃ³digo y nombre son requeridos");

    const salaRef = db.collection("salas").doc(codigo);
    const salaSnap = await salaRef.get();

    if (!salaSnap.exists) {
      alert("La sala no existe");
      return;
    }

    const data = salaSnap.data();
    if (data.jugadores.includes(nombreJugador)) {
      alert("Ese nombre ya estÃ¡ en la sala");
      return;
    }

    try {
      await salaRef.update({
        jugadores: firebase.firestore.FieldValue.arrayUnion(nombreJugador)
      });
      onlineRoomId = codigo;
      onlinePlayerName = nombreJugador;
      isHost = false;
      iniciarEscuchaSala(codigo);
      mostrarControlesSala();
    } catch (error) {
      alert("Error al unirse: " + error.message);
    }
  }

  // Escuchar cambios en la sala
  function iniciarEscuchaSala(roomId) {
    if (unsubscribeRoom) unsubscribeRoom();
    const salaRef = db.collection("salas").doc(roomId);
    unsubscribeRoom = salaRef.onSnapshot((doc) => {
      if (doc.exists) {
        const data = doc.data();
        actualizarListaJugadoresOnline(data.jugadores || []);
      } else {
        // Sala eliminada
        salirDeSala();
      }
    });
  }

  // Actualizar la lista de jugadores online en la UI
  function actualizarListaJugadoresOnline(jugadoresArray) {
    listaJugadoresOnline.innerHTML = "";
    jugadoresArray.forEach(j => {
      const li = document.createElement("li");
      li.textContent = j;
      listaJugadoresOnline.appendChild(li);
    });
  }

  // Mostrar panel de sala activa
  function mostrarControlesSala() {
    onlineRoomControls.style.display = "none";
    onlineJoinPanel.style.display = "none";
    onlineRoomInfo.style.display = "block";
    onlineRoomCodeSpan.textContent = onlineRoomId;
  }

  // Salir de la sala actual
  async function salirDeSala() {
    if (unsubscribeRoom) {
      unsubscribeRoom();
      unsubscribeRoom = null;
    }

    if (onlineRoomId) {
      if (isHost) {
        // AnfitriÃ³n: eliminar la sala
        await db.collection("salas").doc(onlineRoomId).delete();
      } else {
        // Jugador normal: removerse de la lista
        const salaRef = db.collection("salas").doc(onlineRoomId);
        await salaRef.update({
          jugadores: firebase.firestore.FieldValue.arrayRemove(onlinePlayerName)
        });
      }
    }

    onlineRoomId = null;
    onlinePlayerName = "";
    isHost = false;
    onlineRoomInfo.style.display = "none";
    onlineRoomControls.style.display = "block";
  }

  // Agregar jugadores online a la partida local
  function agregarJugadoresLocales() {
    const items = listaJugadoresOnline.querySelectorAll("li");
    items.forEach(li => {
      const nombre = li.textContent;
      if (!jugadores.includes(nombre) && jugadores.length < 10) {
        jugadores.push(nombre);
      }
    });
    renderJugadores();
    alert("Jugadores agregados a la lista local");
  }

  // ========== EVENT LISTENERS ==========
  btnCrearSala.addEventListener("click", crearSala);
  btnUnirseSala.addEventListener("click", () => {
    onlineJoinPanel.style.display = "block";
    onlineRoomControls.style.display = "none";
  });
  btnConfirmarUnirse.addEventListener("click", () => {
    const codigo = document.getElementById("onlineRoomCodeInput").value.trim();
    const nombre = prompt("Ingresa tu nombre para la sala:");
    if (nombre) unirseASala(codigo, nombre);
  });
  btnCancelarUnirse.addEventListener("click", () => {
    onlineJoinPanel.style.display = "none";
    onlineRoomControls.style.display = "block";
  });
  btnSalirSala.addEventListener("click", salirDeSala);
  btnAgregarAJugadores.addEventListener("click", agregarJugadoresLocales);
  btnVolver.addEventListener("click", () => {
    mostrarPantalla("jugadores");
  });

  // BotÃ³n "Conectar Online" en la pantalla de jugadores
  document.addEventListener("DOMContentLoaded", () => {
    // Agregar botÃ³n dinÃ¡micamente en la secciÃ³n jugadores
    const jugadoresSection = document.getElementById("jugadores");
    const btnContinuarCat = document.getElementById("btnContinuarCategorias");
    if (jugadoresSection && btnContinuarCat) {
      const btnConectar = document.createElement("button");
      btnConectar.id = "btnConectarOnline";
      btnConectar.textContent = "ğŸŒ Conectar Online";
      btnConectar.style.marginTop = "20px";
      btnConectar.addEventListener("click", mostrarPantallaOnline);
      btnContinuarCat.insertAdjacentElement("afterend", btnConectar);
    }
  });
</script>
</body>
</html>
